# Smart Call Center - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –õ–æ–≥–∏–∫–∞ –û–±—Ä–∞–±–æ—Ç–∫–∏ –ó–≤–æ–Ω–∫–æ–≤

## üìã –û–±–∑–æ—Ä –°–∏—Å—Ç–µ–º—ã

Smart Call Center –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥** –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–≤–æ–Ω–∫–æ–≤, —Å–æ—á–µ—Ç–∞—é—â–∏–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π Asterisk —Å –≥–∏–±–∫–æ—Å—Ç—å—é –∫–∞—Å—Ç–æ–º–Ω–æ–π –ª–æ–≥–∏–∫–∏ —á–µ—Ä–µ–∑ ARI (Asterisk REST Interface).

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. **–ì–∏–±—Ä–∏–¥–Ω–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–í–∞—Ä–∏–∞–Ω—Ç –í)**

```
–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ ‚Üí Stasis(SmartCallCenter) ‚Üí –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                                           ‚Üì
                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                          ‚Üì                 ‚Üì                 ‚Üì
                    Queue/Direct      IVR/Service      Error Handling
                         ‚Üì                 ‚Üì                 ‚Üì
                 Asterisk Queue    Custom Logic        Fallback
                         ‚Üì                 ‚Üì                 ‚Üì
                   Real-time         WebSocket         Database
                  Monitoring        Notifications        Logging
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
- ‚úÖ –õ—É—á—à–µ–µ –∏–∑ –¥–≤—É—Ö –º–∏—Ä–æ–≤ (Asterisk + –∫–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞)
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π Asterisk
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏

### 2. **–û—Å–Ω–æ–≤–Ω—ã–µ –ú–æ–¥—É–ª–∏**

- **`call_flow_logic.py`** - –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
- **`asterisk_event_handler.py`** - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π ARI –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **`asterisk_database.py`** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å asteriskcdrdb
- **`websocket_manager.py`** - Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º

## üìû –õ–æ–≥–∏–∫–∞ –û–±—Ä–∞–±–æ—Ç–∫–∏ –ó–≤–æ–Ω–∫–æ–≤

### **–ê–ª–≥–æ—Ä–∏—Ç–º –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏**

```python
async def determine_call_routing(call_data):
    """
    1. –ê–Ω–∞–ª–∏–∑ –≤—Ö–æ–¥—è—â–µ–≥–æ –Ω–æ–º–µ—Ä–∞ (DID)
    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞ (–ø—Ä—è–º–æ–π/–æ—á–µ—Ä–µ–¥—å/—Å–µ—Ä–≤–∏—Å–Ω—ã–π)
    4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
    5. –í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    6. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞
    """
```

### **–¢–∏–ø—ã –ó–≤–æ–Ω–∫–æ–≤**

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—Ä–∞–±–æ—Ç–∫–∞ |
|-----|----------|-----------|
| **Direct Extension** | –ü—Ä—è–º–æ–π –∑–≤–æ–Ω–æ–∫ –Ω–∞ extension –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ | Stasis ‚Üí Dial –Ω–∞–ø—Ä—è–º—É—é |
| **Queue Number** | –ó–≤–æ–Ω–æ–∫ –≤ –æ—á–µ—Ä–µ–¥—å | Stasis ‚Üí Asterisk Queue |
| **Service Number** | IVR, –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ | Stasis ‚Üí Custom Logic |
| **Unknown** | –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å |

### **–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –û—á–µ—Ä–µ–¥–µ–π**

#### **üéØ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è: `leastrecent`**
```ini
[queue-support]
strategy = leastrecent
timeout = 25
retry = 3
autopause = yes
ringinuse = no
```

**–ü–æ—á–µ–º—É `leastrecent`:**
- ‚úÖ **–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** - –∑–≤–æ–Ω–∏—Ç —Ç–æ–º—É, –∫—Ç–æ –¥–æ–ª—å—à–µ –≤—Å–µ—Ö –Ω–µ –ø–æ–ª—É—á–∞–ª –∑–≤–æ–Ω–∫–∏
- ‚úÖ **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–≥–æ—Ä–∞–Ω–∏—è** - —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- ‚úÖ **–•–æ—Ä–æ—à–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è** - –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –∑–Ω–∞—é—Ç, —á—Ç–æ —Ä–∞–±–æ—Ç–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —á–µ—Å—Ç–Ω–æ
- ‚úÖ **–ü—Ä–æ—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –ª–µ–≥–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å KPI

#### **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
- **`fewestcalls`** - –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–≤–æ–Ω–∫–æ–≤
- **`linear`** - –¥–ª—è —Ä–∞–∑–Ω–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ (junior ‚Üí senior)
- **`ringall`** - –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –ª–∏–Ω–∏–π (VIP)

## üìä –°–∏—Å—Ç–µ–º–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ KPI

### **–õ–æ–≥–∏–∫–∞ KPI –¥–ª—è –û–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤**

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ó–≤–æ–Ω–æ–∫ –≤ –æ—á–µ—Ä–µ–¥—å ‚Üí –û–ø–µ—Ä–∞—Ç–æ—Ä1 (–Ω–µ –æ—Ç–≤–µ—Ç–∏–ª) ‚Üí –û–ø–µ—Ä–∞—Ç–æ—Ä2 (–æ—Ç–≤–µ—Ç–∏–ª)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–û–ø–µ—Ä–∞—Ç–æ—Ä1 KPI:
‚îú‚îÄ‚îÄ offered_calls: +1    (QueueMemberRingging)
‚îú‚îÄ‚îÄ answered_calls: 0
‚îî‚îÄ‚îÄ missed_calls: +1     (—Ç–∞–π–º–∞—É—Ç –±–µ–∑ –æ—Ç–≤–µ—Ç–∞)

–û–ø–µ—Ä–∞—Ç–æ—Ä2 KPI:
‚îú‚îÄ‚îÄ offered_calls: +1    (QueueMemberRingging)  
‚îú‚îÄ‚îÄ answered_calls: +1   (BridgeEnter)
‚îî‚îÄ‚îÄ missed_calls: 0

–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚îú‚îÄ‚îÄ total_calls: 1
‚îú‚îÄ‚îÄ answered_calls: 1    
‚îú‚îÄ‚îÄ wait_time: X —Å–µ–∫—É–Ω–¥  (QueueCallerJoin ‚Üí QueueCallerLeave)
‚îî‚îÄ‚îÄ answer_rate: 100%
```

### **–°–æ–±—ã—Ç–∏—è Asterisk –¥–ª—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**

| –°–æ–±—ã—Ç–∏–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –î–∞–Ω–Ω—ã–µ |
|---------|------------|--------|
| **QueueCallerJoin** | –°—Ç–∞—Ä—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è | `caller_number`, `queue_name`, `position` |
| **QueueCallerLeave** | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è | `reason` (timeout/transfer/hangup) |
| **QueueMemberRingging** | –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É | `interface`, `queue_name` ‚Üí offered_calls++ |
| **BridgeEnter** | –ó–≤–æ–Ω–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω | ‚Üí answered_calls++ |
| **QueueMemberPause/Unpause** | –°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ | –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã/–ø–∞—É–∑—ã |

## üóÑÔ∏è –ì–∏–±—Ä–∏–¥–Ω–∞—è –ú–æ–¥–µ–ª—å –î–∞–Ω–Ω—ã—Ö

### **–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –î–∞–Ω–Ω—ã—Ö**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ò—Å—Ç–æ—á–Ω–∏–∫      ‚îÇ    –î–∞–Ω–Ω—ã–µ        ‚îÇ   –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ SmartCallCenter ‚îÇ ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–∞—è      ‚îÇ ‚Ä¢ –û–ø–µ—Ä–∞—Ç–æ—Ä—ã     ‚îÇ
‚îÇ MongoDB         ‚îÇ   —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞     ‚îÇ ‚Ä¢ –û—á–µ—Ä–µ–¥–∏       ‚îÇ
‚îÇ                 ‚îÇ ‚Ä¢ –°–æ–±—ã—Ç–∏—è ARI    ‚îÇ ‚Ä¢ Real-time     ‚îÇ
‚îÇ                 ‚îÇ ‚Ä¢ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏    ‚îÇ ‚Ä¢ WebSocket     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Asterisk CDR    ‚îÇ ‚Ä¢ –ë–∞–∑–æ–≤—ã–µ        ‚îÇ ‚Ä¢ –ë–∏–ª–ª–∏–Ω–≥       ‚îÇ
‚îÇ (asteriskcdrdb) ‚îÇ   —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–µ     ‚îÇ ‚Ä¢ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ‚îÇ
‚îÇ                 ‚îÇ   –º–µ—Ç—Ä–∏–∫–∏        ‚îÇ ‚Ä¢ –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã     ‚îÇ
‚îÇ                 ‚îÇ ‚Ä¢ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å  ‚îÇ ‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –î–∞–Ω–Ω—ã—Ö**

1. **Real-time:** –°–æ–±—ã—Ç–∏—è ARI ‚Üí SmartCallCenter DB
2. **Batch:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å CDR
3. **–ì–∏–±—Ä–∏–¥–Ω—ã–µ –æ—Ç—á–µ—Ç—ã:** –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±–µ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

## üîÑ Real-time –û–±—Ä–∞–±–æ—Ç–∫–∞ –°–æ–±—ã—Ç–∏–π

### **WebSocket –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

```
Asterisk ARI ‚îÄ‚îÄWebSocket‚îÄ‚îÄ‚Üí Event Handler ‚îÄ‚îÄ‚Üí Business Logic
     ‚Üì                           ‚Üì                    ‚Üì
 ARI Events              Call Flow Logic      Database Update
     ‚Üì                           ‚Üì                    ‚Üì
WebSocket Stream        Routing Decision    WebSocket Notifications
     ‚Üì                           ‚Üì                    ‚Üì
Smart Call Center       Execute Action        Frontend Update
```

### **–ü–æ—Ç–æ–∫ –û–±—Ä–∞–±–æ—Ç–∫–∏ –ó–≤–æ–Ω–∫–∞**

1. **StasisStart** ‚Üí –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Üí –†–µ—à–µ–Ω–∏–µ –æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
2. **QueueCallerJoin** ‚Üí –ó–∞–ø–∏—Å—å –≤ –ë–î ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞–º
3. **QueueMemberRingging** ‚Üí offered_calls++ ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
4. **BridgeEnter** ‚Üí answered_calls++ ‚Üí –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
5. **ChannelStateChange** ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí Real-time –º–µ—Ç—Ä–∏–∫–∏
6. **QueueCallerLeave** ‚Üí –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Üí –û—Ç—á–µ—Ç—ã

## üõ†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Asterisk

### **–§–∞–π–ª—ã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**

#### **extensions.conf**
```ini
[internal]
; –í—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Stasis
exten => _X.,1,Stasis(SmartCallCenter,${EXTEN})

[from-trunk]  
; –í–Ω–µ—à–Ω–∏–µ –∑–≤–æ–Ω–∫–∏
exten => _X.,1,Set(CALLERID(name)=External Call)
same => n,Goto(internal,${EXTEN},1)
```

#### **queues.conf**
```ini
[support]
strategy = leastrecent
timeout = 25
retry = 3
autopause = yes
ringinuse = no
announce-frequency = 60
announce-position = yes
```

#### **ari.conf**
```ini
[smart-call-center]
type = user
read_only = no
password = Almaty20252025
```

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Extensions**

```ini
[pjsip.conf]
[0001]
type=endpoint
auth=0001
aors=0001
context=internal

[0777]
type=endpoint  
auth=0777
aors=0777
context=internal
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### **–û–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –ú–µ—Ç—Ä–∏–∫–∏**

```python
class OperatorKPI:
    offered_calls: int      # QueueMemberRingging
    answered_calls: int     # BridgeEnter
    missed_calls: int       # Timeout –±–µ–∑ –æ—Ç–≤–µ—Ç–∞
    avg_talk_time: float    # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    online_time: int        # –í—Ä–µ–º—è –≤ —Å—Ç–∞—Ç—É—Å–µ available
    pause_time: int         # –í—Ä–µ–º—è –Ω–∞ –ø–∞—É–∑–µ
    efficiency: float       # answered/offered * 100
```

### **–û—á–µ—Ä–µ–¥–Ω—ã–µ –ú–µ—Ç—Ä–∏–∫–∏**

```python
class QueueKPI:
    total_calls: int        # QueueCallerJoin
    answered_calls: int     # Successful transfers
    abandoned_calls: int    # QueueCallerLeave(reason=timeout)
    avg_wait_time: float    # Join‚ÜíLeave time
    service_level: float    # % answered within SLA
    answer_rate: float      # answered/total * 100
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –°–∏—Å—Ç–µ–º—ã

### **1. –ë–∞–∑–æ–≤–∞—è –ù–∞—Å—Ç—Ä–æ–π–∫–∞**

```bash
# 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Asterisk
systemctl restart asterisk

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoints
asterisk -rx "pjsip show endpoints"

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ ARI
asterisk -rx "ari show users"

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π
asterisk -rx "queue show"
```

### **2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Smart Call Center**

```python
# config.py
DEFAULT_ASTERISK_HOST = "92.46.62.34"
DEFAULT_ASTERISK_PORT = 8088
DEFAULT_ASTERISK_USERNAME = "smart-call-center"
DEFAULT_ASTERISK_PASSWORD = "Almaty20252025"
PRODUCTION_MODE = True
DISABLE_VIRTUAL_ARI = True
```

### **3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î Asterisk**

```python
# –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Asterisk Database
{
    "host": "localhost",
    "port": 3306,
    "username": "asterisk", 
    "password": "password",
    "database": "asteriskcdrdb",
    "db_type": "mysql",
    "enabled": True
}
```

## üéØ –†–µ–∂–∏–º—ã –†–∞–±–æ—Ç—ã

### **–ü—Ä–æ–¥–∞–∫—à–Ω –†–µ–∂–∏–º**

- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É Asterisk (92.46.62.34:8088)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–µ –ë–î (SmartCallCenter + CDR)
- ‚úÖ Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
- ‚úÖ –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### **–¢–µ—Å—Ç–æ–≤—ã–π –†–µ–∂–∏–º**

- üß™ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π ARI –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- üß™ –ò–º–∏—Ç–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤
- üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Asterisk

## üìö API Endpoints

### **Asterisk Integration**
- `GET /api/asterisk/extensions` - –°–ø–∏—Å–æ–∫ extensions
- `GET /api/asterisk/realtime-data` - Real-time –¥–∞–Ω–Ω—ã–µ
- `POST /api/asterisk/connect` - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ARI

### **Database Integration**  
- `GET /api/admin/settings/asterisk-database` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î
- `POST /api/admin/settings/asterisk-database/test` - –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `GET /api/admin/reports/cdr-data` - CDR –¥–∞–Ω–Ω—ã–µ
- `GET /api/admin/reports/hybrid-statistics` - –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### **Setup Wizard**
- `POST /api/setup/asterisk/scan` - –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Asterisk
- `POST /api/setup/operators/migrate` - –ú–∏–≥—Ä–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- `POST /api/setup/complete` - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üöÄ –ó–∞–ø—É—Å–∫ –≤ –ü—Ä–æ–¥–∞–∫—à–Ω

### **Checklist**

1. ‚úÖ **Asterisk –Ω–∞—Å—Ç—Ä–æ–µ–Ω** —Å Stasis –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º SmartCallCenter
2. ‚úÖ **Extensions —Å–æ–∑–¥–∞–Ω—ã** –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤  
3. ‚úÖ **–û—á–µ—Ä–µ–¥–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã** —Å–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π leastrecent
4. ‚úÖ **ARI –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** smart-call-center —Å–æ–∑–¥–∞–Ω
5. ‚úÖ **Smart Call Center** –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É Asterisk
6. ‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** asteriskcdrdb –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
7. ‚úÖ **–û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å–æ–∑–¥–∞–Ω—ã** —á–µ—Ä–µ–∑ –º–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
8. ‚úÖ **WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** —Ä–∞–±–æ—Ç–∞—é—Ç
9. ‚úÖ **–¢–µ—Å—Ç–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏** –ø—Ä–æ—Ö–æ–¥—è—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

- üìä **Dashboard** - Real-time –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
- üìà **Analytics** - –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- üîç **Logs** - –°–æ–±—ã—Ç–∏—è ARI –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
- ‚ö†Ô∏è **Alerts** - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö

## üîç –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ù–µ–ø–æ–ª–∞–¥–æ–∫

### **–ß–∞—Å—Ç—ã–µ –ü—Ä–æ–±–ª–µ–º—ã**

1. **ARI –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å 92.46.62.34:8088
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å smart-call-center
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ HTTP –≤ Asterisk

2. **–°–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Stasis –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ SmartCallCenter
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `/var/log/supervisor/backend.*.log`

3. **–û–ø–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –∑–≤–æ–Ω–∫–∏**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å extensions –≤ PJSIP
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –æ—á–µ—Ä–µ–¥—è–º
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ

### **–õ–æ–≥–∏ –∏ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**

```bash
# Asterisk –ª–æ–≥–∏
tail -f /var/log/asterisk/messages

# Smart Call Center –ª–æ–≥–∏  
tail -f /var/log/supervisor/backend.*.log

# –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–µ—Ä–µ–¥–µ–π
asterisk -rx "queue show"

# –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
asterisk -rx "core show channels"
```

## üìñ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ Asterisk
- **–ì–∏–±–∫–æ—Å—Ç—å** - –∫–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ —á–µ—Ä–µ–∑ ARI
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ—Å—Ç–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
- **–ê–Ω–∞–ª–∏—Ç–∏–∫—É** - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- **Real-time** - –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–≤–æ–Ω–∫–∏ —Å –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º.